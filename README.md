**Корпоративный сайт my.cic.kz**

Это хранилище сайта my.cic.kz и всех его подпроектов.

Проект использует фреймворк Laravel v 6.0 с кастомным шаблоном для подпроектной разработки.

Установка

Клонирование

Изначальное разворачивание проекта происходит:

**git clone git@bitbucket.org:centras/my.cic.kz.git**

Через Homestead(Vagrant)

**Требования :** 

VirtualBox 6.0 или выше;

Vagrant;

**Установка :** 

После установки требуемых ПО, нужно ввести в консоли комманду 

_`vagrant box add laravel/homestead`_

Скачиваем себе 



Создать GitHub personal API token
Конфигурация
Нужно сделать для конфигурации локальную копию подготовленного примера:

cd vagrant/config
cp vagrant-local.example.yml vagrant-local.yml
Затем в этот файл поместить GitHub personal API token.

База данных
Опционально. Если есть файл БД, его можно поместить в /app/vagrant/database/agent.sql. При создании машины Vagrant импортирует файл и создаст по нему поисковые индексы.

SSL
Опционально. Если есть готовый сертификат с ключом, их можно поместить в /vagrant/ssl под названиями dev.key и dev.cert. В ином случае они будут сгенерированы и их нужно добавить в доверенные.

После этого АП и подпроекты будут доступны не только по http://, но и по https://.

Запуск
Нужно установить плагин (только один раз) и запустить машину:

vagrant plugin install vagrant-hostmanager
vagrant up
Vagrant скачает и подготовит окружение. Сайт с подсайтами будут доступны по адресам:

http://agent.dev
http://admin.agent.dev
http://statistic.agent.dev
http://api.agent.dev
Также доступны тестовые пользователи (у всех пароль 123456):

Для админки adminTest
Для АП agent
Вручную
Требования
Установите все необходимые зависимости, следуя их документации.

TODO: Оформить все зависимости

PHP >= 5.4
php5-imagick
composer
deployer 4.1.0
RabbitMQ
Библиотеки
В проекте используется composer.

Перед установкой зависимостей запустите следующую команду для установки Composer Asset Plugin:

composer global require "fxp/composer-asset-plugin:^1.2.0"
Для установки зависимостей запустите команду:

composer install
Инициализация
Перед началом работы проект необходимо инициализровать.

Инициализация проекта создает во всех DOCROOT проектов (project/www) index.php и во всех директориях конфигураций (project/config) файлы конфигурации и параметров main-local.php и params-local.php

Инициализировать его можно в одной из нескольких стадий, на данный момент существует их две:

Production - для продакшена
Development - для разработки
Для интерактивной инициализации запустите команду:

./init
Эта команда взята целиком из Yii2. В интерактивном режиме она поможет выбрать стадию и перезаписать при необходимости файлы.

Конфигурация
Во всех частях проекта присутствуют конфигурационные файлы, основные из которых main.php и params.php. Кроме того используются в обязательном порядке их локальные варианты - main-local.php и params-local.php, которые можно либо сгенерировать через скрипт инициализации:

./init
Либо создать их вручную как минимум с пустым массивом:

<?php
return [];
Укажите конфигурацию базы данных в common/main-local.php на основе конфигурации common/main.php.

Миграции
Миграции осуществляются командой migration:

./yiic migration
Остальные подкоманды соответствуют команде migrate. Миграции хранятся в common\migrations.

Ресурсы
В этом разделе описаны необходимые манипуляции с ресурсами для разворачивания проекта.

CSS
В проекте используется SASS для css. Для установки SASS нужно поставить ruby, после чего из командной строки запустить:

gem install sass
Если у вас есть дополнительные вопросы, обратитесь к разделам установки и документации на сайте SASS.

Затем можно запустить вотчер для стилей, чтобы sass автоматически компилировал стили при изменении:

sass --watch management/www/css/main.scss:frontend/www/css/main.css
Либо можно запустить создание стилей вручную:

./compile [project1,project2...]
Скрипт принимает строку со списком проектов для создания стилей через запятую.

Компиляция
Продакшн использует сжатые варианты стилей и скриптов. Для создания таковых, нужно запустить из корня проекта команду assets:

./yiic assets
После чего будут созданы соответствующие min.css и min.js в подпроектах.

Внешние источники
TODO: Epay и Esbd

Разворачивание на продакшене
В проекте используется deployer для загрузки проекта на продакшн.

dep deploy production
Для вывода списка существующих параметров, запустите:

dep help
Для вывода существующих задач:

dep list
Есть две стадии для разворачивания: production - продакшн по внутреннему адресу (192.168.1.6) beta - тестовый по внутреннему адресу (192.168.1.6)

Разворачивание проекта происходит посредством задачи deploy:

dep deploy [--branch=branchname] production|beta
Первая загрузка проекта
При первой загрузке проекта на сервер можно использовать команду следующим образом:

dep4 --init-rewrite="y" --run-migrations="n" deploy production
В этом случае не будет применено миграций для БД. --init-rewrite нужен для перезаписи файлов конфигурации, которые создаются пустыми через символические ссылки.

После разворачивания проекта можно настроить конфигурацию для подключения к БД и прочие необходимые вещи, после чего обычная задача deploy будет отрабатываться должным образом.

TODO: Описание команды и опций

Очереди обработки полисов
Для обрабтки полисов используется RabbitMQ.

Настройка RabbitMQ
На сервере может потребоваться создать пользователя для администрирования:

rabbitmqctl add_user admin password
rabbitmqctl set_user_tags admin administrator
rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"
После чего добавить информацию о пользовательском логине и пароле в common/config/main-local.php:

return [
    ...
    'components' => [
        ...

        'rabbitMq' => [
            'login' => 'admin',
            'password' => 'password',
        ],

        ...
    ],
    ...
];
Чтоб добавить панель администирования, нужно включить соответствующий плагин:

rabbitmq-plugins enable rabbitmq_management
Запуск обработки
Чтоб запустить очередь обработки, нужно выполнить следующую команду в корне проекта:

./yiic rabbitmq processQueue --queue="source_project_type"
где:

source  - источник обработки, например `insis`
project - префикс проекта, например `ap`
type    - тип полисов, напримр `ogpo`
Например:

/yiic rabbitmq processQueue --queue="insis_ap_ogpo"
Префикс проекта можно поменять в параметре insisDocCodePrefix в common/config/params.php.

Гайдлайны
Болванка для будущих гайдлайнов
К кому обратиться
Александр Хан akhan@cic.kz
Артур Асланян AAslanyan@cic.kz